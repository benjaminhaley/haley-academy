<panel ng-if="test_loaded && should_show_discussion()">
  <div class="panel-heading">
    <panel-title>
      <strong><i class="fa fa-comments"></i></strong> discussion
      <span class="text-muted pull-right" 
            ng-click="update_discussion_from_server()" 
            popover="update discussion" 
            popover-placement="bottom" 
            popover-trigger="mouseenter">
            <small>
              <i ng-if="!updating_discussion_from_server" 
                 class="fa fa-refresh"></i>
              <i ng-if="updating_discussion_from_server" 
                 class="fa fa-spinner fa-spin"></i>
            </small>
      </span>
    </panel-title>
  </div>
  <ul class="list-group">
    
    <!-- Add a contribution if I don't have any -->
    <span ng-if="!i_have_any(discussion.contributions)">
      <span ng-init="add_child(new_item(type='contribution'), 
                               discussion)">
      </span>
    </span>

    <li class="list-group-item"
        ng-repeat="contribution in contributions_to_show() | orderBy : contribution_rank : true track by contribution.modified">
      <div ng-if="!(user == contribution.user && 
                     (contribution.editing || !contribution.saved_content))">
        <br>
        <table>
        <tr>
        
          <!-- Voting -->
          <td class="center-block" 
              style="width:40px;">
            <div ng-if="!user_is_logged_in()"
                 class="text-center text-muted"
                 ng-click="ask_user_to_log_in()"
                 popover="Sign in to vote" 
                 popover-placement="right" 
                 popover-trigger="mouseenter">
              <i class="fa fa-caret-up"></i>
            </div>
            <div ng-if="user_is_logged_in() && 
                        !i_have_any(contribution.upvotes) && 
                        !i_have_any(contribution.downvotes) && 
                        !is_my(contribution)"
                 class="text-center clickable text-muted"
                 ng-click="vote = vote || new_item('vote', {'content': 'up'});
                           save_item(vote, {'parent': contribution})" 
                 popover="Great point!" 
                 popover-placement="right" 
                 popover-trigger="mouseenter">
              <span ng-if="!vote.saving && !vote.save_failed"><i class="fa fa-caret-up"></i></span>
              <span ng-if="vote.saving"><i class="fa fa-spinner fa-spin"></i></span>
              <span ng-if="vote.save_failed"><i class="fa fa-caret-up"></i></span>
            </div>
            <div ng-if="user_is_logged_in() && 
                        i_have_any(contribution.upvotes) && 
                        !is_my(contribution)"
                 class="text-center clickable"
                 ng-click="vote = get_my(contribution.upvotes);
                           delete_item(vote);" 
                 popover="Remove your upvote" 
                 popover-placement="right" 
                 popover-trigger="mouseenter">
              <b ng-if="!vote.deleting && !vote.delete_failed"><i class="fa fa-caret-up"></i></b>
              <span ng-if="vote.deleting"><i class="fa fa-spinner fa-spin"></i></span>
              <span ng-if="vote.delete_failed"><i class="fa fa-caret-up"></i></span>
            </div>
            <div class="text-center"
                  popover="{{voting_summary(contribution)}}" 
                  popover-placement="right" 
                  popover-trigger="mouseenter"
            >
              {{upvote_count(contribution) - downvote_count(contribution)}}
            </div>
            <div  ng-if="user_is_logged_in() && 
                         is_teacher() && 
                         !i_have_any(contribution.downvotes) && 
                         !i_have_any(contribution.upvotes) && 
                         !is_my(contribution)"
                  class="text-center clickable text-muted"
                  ng-click="vote = vote || new_item('vote', {'content': 'down'});
                            save_item(vote, {'parent': contribution})" 
                  popover="Not helpful.  Hide this post." 
                  popover-placement="right" 
                  popover-trigger="mouseenter">
              <span ng-if="!vote.saving && !vote.save_failed"><i class="fa fa-caret-down"></i></span>
              <span ng-if="vote.saving"><i class="fa fa-spinner fa-spin"></i></span>
              <span ng-if="vote.save_failed"><i class="fa fa-caret-down"></i></span>
            </div>
            <div  ng-if="user_is_logged_in() && 
                         i_have_any(contribution.downvotes) && 
                         !is_my(contribution)"
                  class="text-center clickable"
                  ng-click="vote = get_my(contribution.downvotes);
                            delete_item(vote)" 
                  popover="Remove your downvote." 
                  popover-placement="right" 
                  popover-trigger="mouseenter">
              <b ng-if="!vote.deleting && !vote.delete_failed"><i class="fa fa-caret-down"></i></b>
              <span ng-if="vote.deleting"><i class="fa fa-spinner fa-spin"></i></span>
              <span ng-if="vote.delete_failed"><i class="fa fa-caret-down"></i></span>
            </div>
          </td>
          
          
          <td style="width:100%;">
            <!-- Other's contributions -->
            <div ng-if="user != contribution.user">
              <p ng-bind-html="contribution.content | trust"></p>
          
              <!-- Signature -->
              <span class="text-muted">
                <small>
                  <em>- {{contribution.user}}  {{ contribution.modified | ago }}
                  </em>
                </small>
              </span>
              
              <!-- Comments -->
              <comments></comments>
            </div>
  
            <!-- My contribution -->
            <div ng-if="user == contribution.user &&
                        !contribution.editing &&
                        contribution.saved_content">
              <p ng-bind-html="contribution.content | trust" 
                 ng-click="edit_item(contribution)" 
                 popover="Click to edit your contribution" 
                 popover-placement="bottom" 
                 popover-trigger="mouseenter"></p>
                 
              <!-- Signature -->
              <span class="text-muted">
                <small>
                  <em>- {{contribution.user}}  {{ contribution.modified | ago }} </em>
                </small>
                <span ng-if="!contribution.editing">
                  <span   class="clickable" 
                          ng-really-message="Really delete your contribution?  This cannot be undone." 
                          ng-really-click="delete_item(contribution)"
                          popover="Delete your contribution" 
                          popover-placement="left" 
                          popover-trigger="mouseenter">
                    <span aria-hidden="true">
                      <b ng-if="!contribution.deleting && !contribution.delete_failed">&times;</b>
                      <span ng-if="contribution.deleting"><i class="fa fa-spinner fa-spin"></i></span>
                      <span ng-if="contribution.delete_failed"><br>Could not delete your comment.  Click here to try again.</span>
                    </span>
                  </span>
                </span>
              </span>

              <!-- Comments -->
              <comments></comments>
            </div>
            <br>
          </td>
        </tr>
      </table>
      </div>
      
      <!-- Editing my contribution -->
      <div ng-if="user == contribution.user && 
                  (contribution.editing || !contribution.saved_content)">
          <textarea class="form-control" 
                    rows="5" 
                    ng-model="contribution.content" 
                    ng-model-options="{ debounce: 200 }"
                    placeholder="Share your insights on this problem.  What mistakes did you make working on it?  What tricks did you use to help solve it?"></textarea>
          <br ng-if="contribution.content">
          <button type="button" 
                  class="btn btn-default" 
                  ng-click="save_item(contribution)" 
                  ng-if="contribution.content">
                    <span ng-if="!contribution.saving && !contribution.save_failed">Save</span>
                    <span ng-if="contribution.saving">Saving <i class="fa fa-spinner fa-spin"></i></span>
                    <span ng-if="contribution.save_failed">Could not save, click to retry</span>
                  </button>
          <button type="button" 
                  class="btn btn-default" 
                  ng-click="cancel_my(contribution)" 
                  ng-if="contribution.content">Cancel</button>
        </div>

    </li>
    
    <!-- hidden discussion -->
    <li class="list-group-item"
        ng-if="!discussion.show_downvoted_contributions && downvoted_contributions().length > 0">
      <span class="clickable text-muted"
            ng-click="discussion.show_downvoted_contributions = true;">
        <small>
          <i class="fa fa-plus"></i>
          show {{downvoted_contributions().length}} downvoted contributions
        </small>
      </span>
    </li>
    <li class="list-group-item"
        ng-if="discussion.show_downvoted_contributions">
      <span class="clickable text-muted"
            ng-click="discussion.show_downvoted_contributions = false;">
        <small>
          <i class="fa fa-minus"></i>
          hide {{downvoted_contributions().length}} downvoted contributions
        </small>
      </span>
    </li>
  </ul>
</panel>
